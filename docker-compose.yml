services:
  postgres:
    extends:
      file: docker-services-compose.yml
      service: postgres

  elasticsearch:
    extends:
      file: docker-services-compose.yml
      service: elasticsearch
  hastehealth-migrate:
    extends:
      file: docker-services-compose.yml
      service: hastehealth-migrate
  hastehealth-server:
    image: ghcr.io/hastehealth/hastehealth/hastehealth:latest
    platform: linux/amd64
    ports:
      - 3000:3000
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch: 
        condition: service_healthy
    command:
      - server
      - start
    environment:
      - CERTIFICATION_DIR=certifications
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/haste_health
      - API_URI=http://localhost:3000
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=elastic
      - ADMIN_APP_REDIRECT_URI=http://*.localhost:3001
    
  hastehealth-worker:
    image: ghcr.io/hastehealth/hastehealth/hastehealth:latest
    platform: linux/amd64
    command:
      - worker
    depends_on:
      postgres:
        condition: service_healthy
      elasticsearch: 
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/haste_health
      - ELASTICSEARCH_URL=http://elasticsearch:9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=elastic

  hastehealth-admin-app:
    image: ghcr.io/hastehealth/hastehealth/admin-app:latest
    platform: linux/amd64
    ports:
      - 3001:80
    depends_on:
      - hastehealth-worker
      - hastehealth-server
    environment:
      - REACT_APP_FHIR_BASE_URL=http://localhost:3000
    
---
id: scopes
title: Scopes
sidebar_position: 4
tags:
  - authentication
  - authorization
  - oauth2
  - smart-on-fhir
  - scopes
---

# Scopes

Haste Health implements a comprehensive scope system that combines OpenID Connect (OIDC) scopes with SMART on FHIR scopes to provide fine-grained access control for healthcare applications.

## Overview

Scopes define what permissions an access token grants. When a client application requests an access token, it specifies the scopes it needs. The authorization server then issues a token with the approved scopes, which determine what resources and operations the client can access.

Haste Health supports two types of scopes:

1. **OIDC Scopes** - Standard OpenID Connect scopes for authentication and user information
2. **SMART Scopes** - Healthcare-specific scopes following the SMART on FHIR specification

## OIDC Scopes

OpenID Connect scopes provide basic authentication and user profile information.

### Available OIDC Scopes

| Scope | Description |
|-------|-------------|
| `openid` | Required for OpenID Connect authentication. Indicates that the application intends to use OIDC to verify the user's identity. |
| `profile` | Grants access to the user's default profile claims (name, family_name, given_name, etc.). |
| `email` | Grants access to the user's email address and email_verified claims. |
| `offline_access` | Requests a refresh token that allows the application to obtain new access tokens without user interaction. Used for long-running or background access. |
| `online_access` | Requests access limited to the current session. No refresh token is issued. |

### Example OIDC Scope Requests

```
openid profile email
```

```
openid profile offline_access
```

## SMART on FHIR Scopes

SMART scopes provide fine-grained access control over FHIR resources and operations. They follow the SMART App Launch specification.

### SMART Scope Format

SMART resource scopes follow this pattern:

```
user/resource.permissions
```

Where:
- **user**: The access level (`user`, `patient`, or `system`)
- **resource**: The FHIR resource type or `*` for all resources
- **permissions**: The allowed operations (combination of `c`, `r`, `u`, `d`, `s`)

### Access Levels (User Context)

| Level | Description | Use Case |
|-------|-------------|----------|
| `user` | Access resources in the context of a logged-in user | Clinician applications, provider portals |
| `patient` | Access resources in the context of a specific patient | Patient-facing applications, personal health records |
| `system` | Access resources without a user context | Backend services, system integrations, automated processes |

### Permission Characters

Permissions must be specified in the order: **c-r-u-d-s**

| Character | Permission | Operations Included |
|-----------|------------|---------------------|
| `c` | Create | Type-level create |
| `r` | Read | Instance-level read, vread, history |
| `u` | Update | Instance-level update, patch (may also create new instances) |
| `d` | Delete | Instance-level delete |
| `s` | Search | Type-level search and history, system-level search and history |

#### Permission Shortcuts

| Shortcut | Equivalent | Description |
|----------|------------|-------------|
| `*` | `cruds` | All permissions |
| `read` | `rs` | Read and search only |
| `write` | `cud` | Create, update, and delete only |

**Important:** Permissions must be in order. Invalid orderings like `dcu` or `sr` will be rejected.

### Resource Scope Examples

#### Single Resource Type

```
user/Patient.read
```
Grants read and search access to Patient resources in user context.

```
patient/Observation.rs
```
Grants read and search access to Observation resources in patient context (same as `patient/Observation.read`).

```
system/Medication.cruds
```
Grants full access to Medication resources in system context (same as `system/Medication.*`).

#### All Resources

```
user/*.read
```
Grants read and search access to all resource types in user context.

```
system/*.*
```
Grants full access to all resource types in system context (same as `system/*.cruds`).

#### Specific Permissions

```
user/Patient.cru
```
Grants create, read, update, and search (via read) access to Patient resources, but not delete.

```
system/Observation.rs
```
Grants read and search access to Observation resources in system context.

```
patient/Condition.r
```
Grants read-only access (no search) to Condition resources in patient context.

### Launch Scopes

Launch scopes are used in SMART App Launch workflows to establish context for EHR-integrated applications.

| Scope | Description |
|-------|-------------|
| `launch` | Required for SMART launch from an EHR. Indicates the app is being launched from within an EHR workflow. |
| `launch/patient` | Requests that a patient be selected and made available in the launch context. |
| `launch/encounter` | Requests that an encounter be selected and made available in the launch context. |

### Special SMART Scopes

| Scope | Description |
|-------|-------------|
| `fhirUser` | Requests the identity of the current user as a FHIR resource reference (e.g., `Practitioner/123`). |

## Combining Scopes

Multiple scopes can be requested together by separating them with spaces.

### Example: Patient Portal Application

```
openid profile email patient/*.read launch/patient fhirUser
```

This grants:
- OpenID Connect authentication
- Access to user profile and email
- Read access to all FHIR resources for the patient
- Patient launch context
- User identity as FHIR reference

### Example: Clinician EHR Application

```
openid profile offline_access launch/patient user/Patient.* user/Observation.* user/Condition.rs fhirUser
```

This grants:
- OpenID Connect authentication
- User profile access
- Refresh token for offline access
- Patient launch context
- Full access to Patient resources
- Full access to Observation resources
- Read and search access to Condition resources
- User identity as FHIR reference

### Example: Backend Integration Service

```
system/*.* offline_access
```

This grants:
- Full access to all FHIR resources without user context
- Refresh token for long-running access

### Example: Read-Only Analytics Service

```
system/*.read offline_access
```

This grants:
- Read and search access to all FHIR resources
- Refresh token for continuous data access

## Scope Request Flow

### 1. Authorization Request

When initiating OAuth 2.0 authorization, the client includes requested scopes:

```http
GET /w/{tenant}/auth/authorize?
  response_type=code&
  client_id=my-app&
  redirect_uri=https://app.example.com/callback&
  scope=openid profile patient/*.read launch/patient fhirUser&
  state=xyz123&
  aud=https://api.haste.health/w/{tenant}/api/v1/{project}/fhir/r4
```

### 2. User Consent

The authorization server presents the requested scopes to the user for approval. Users may approve or deny specific scopes.

### 3. Token Response

The issued access token includes the approved scopes:

```json
{
  "access_token": "eyJhbGc...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "openid profile patient/*.read launch/patient fhirUser",
  "refresh_token": "tGzv3JOk...",
  "patient": "Patient/123"
}
```

### 4. Using the Token

The application includes the access token in API requests:

```http
GET /w/{tenant}/api/v1/{project}/fhir/r4/Observation?patient=Patient/123
Authorization: Bearer eyJhbGc...
```

The server validates that the token has the required scope (e.g., `patient/Observation.read` or `patient/*.read`).

## Scope Validation Rules

### Permission Ordering

Permissions **must** be in the correct order: `c-r-u-d-s`

✅ **Valid:**
- `patient/Patient.cr`
- `user/Observation.cruds`
- `system/*.cud`

❌ **Invalid:**
- `patient/Patient.rc` (wrong order)
- `user/Observation.duc` (wrong order)
- `system/*.sdr` (wrong order)

### Scope Syntax

✅ **Valid:**
- `user/Patient.read`
- `patient/*.cruds`
- `system/Observation.rs`
- `launch/patient`
- `fhirUser`

❌ **Invalid:**
- `usr/Patient.read` (invalid user level)
- `patient/Patient` (missing permissions)
- `system/InvalidResource.read` (invalid resource type)
- `launch/invalid` (invalid launch type)

### Resource Type Validation

Only valid FHIR resource types are accepted:

✅ **Valid:**
- `user/Patient.read`
- `user/Observation.read`
- `user/Practitioner.read`

❌ **Invalid:**
- `user/InvalidType.read` (not a FHIR resource type)
- `user/patient.read` (case-sensitive, must be `Patient`)

## Access Control Examples

### Example 1: Patient Read Access

**Token Scopes:** `patient/Patient.read patient/Observation.read`

✅ **Allowed:**
```http
GET /fhir/r4/Patient/123
GET /fhir/r4/Observation?patient=Patient/123
```

❌ **Denied:**
```http
POST /fhir/r4/Patient (no create permission)
PUT /fhir/r4/Patient/123 (no update permission)
GET /fhir/r4/Condition/456 (no Condition scope)
```

### Example 2: User Write Access

**Token Scopes:** `user/Patient.cud user/*.rs`

✅ **Allowed:**
```http
POST /fhir/r4/Patient (create)
PUT /fhir/r4/Patient/123 (update)
DELETE /fhir/r4/Patient/123 (delete)
GET /fhir/r4/Observation/456 (read via wildcard)
GET /fhir/r4/Observation?patient=Patient/123 (search via wildcard)
```

❌ **Denied:**
```http
GET /fhir/r4/Patient/123 (no read permission for Patient)
POST /fhir/r4/Observation (no create permission for other resources)
```

### Example 3: System Full Access

**Token Scopes:** `system/*.*`

✅ **Allowed:**
```http
POST /fhir/r4/Patient
GET /fhir/r4/Patient/123
PUT /fhir/r4/Patient/123
DELETE /fhir/r4/Patient/123
GET /fhir/r4/Observation?patient=Patient/123
POST /fhir/r4/Bundle (transaction)
```

All operations on all resources are allowed in system context.

## Best Practices

### Request Minimal Scopes

Only request the scopes your application actually needs. This follows the principle of least privilege:

✅ **Good:**
```
patient/Patient.read patient/Observation.read patient/Condition.read
```

❌ **Avoid:**
```
patient/*.*
```

### Use Appropriate User Context

Choose the correct user context for your application:

- **Patient apps**: Use `patient/` scopes
- **Clinician apps**: Use `user/` scopes
- **Backend services**: Use `system/` scopes

### Combine Scopes Appropriately

Group related scopes together:

```
openid profile patient/Patient.read patient/Observation.read launch/patient
```

### Request Refresh Tokens Carefully

Only request `offline_access` if your application needs long-term access:

✅ **Appropriate:**
- Background sync services
- Long-running data analysis
- Continuous monitoring applications

❌ **Inappropriate:**
- Single-page web apps with short sessions
- Applications that only need temporary access

### Handle Scope Downgrades

The authorization server may grant fewer scopes than requested. Always check the actual granted scopes in the token response:

```typescript
if (tokenResponse.scope.includes('patient/Observation.read')) {
  // Safe to read Observations
} else {
  // Scope not granted, disable feature
}
```

## Scope String Format

Scopes are represented as space-separated strings:

```
openid profile email patient/*.read launch/patient fhirUser
```

### Parsing Scope Strings

**JavaScript/TypeScript:**
```typescript
const scopeString = "openid profile patient/*.read";
const scopes = scopeString.split(' ');
// ['openid', 'profile', 'patient/*.read']
```

### Generating Scope Strings

**JavaScript/TypeScript:**
```typescript
const scopes = ['openid', 'profile', 'patient/*.read'];
const scopeString = scopes.join(' ');
// 'openid profile patient/*.read'
```

## Security Considerations

### Scope Creep

Avoid requesting overly broad scopes. Request only what your application needs:

❌ **Bad:** Always requesting `system/*.*`
✅ **Good:** Requesting specific scopes like `user/Patient.read user/Observation.read`

### Token Lifetime

Tokens with broad scopes should have shorter lifetimes:

- `system/*.*` tokens: Short-lived (e.g., 1 hour)
- Specific scopes: Longer-lived (e.g., 8 hours)
- Use refresh tokens for long-term access instead of long-lived access tokens

### Scope Validation

Always validate that the token has the required scope before performing operations:

```typescript
function requireScope(requiredScope: string, tokenScopes: string[]) {
  if (!tokenScopes.includes(requiredScope)) {
    throw new Error('Insufficient scope');
  }
}
```

### Audit Logging

Log scope usage for security auditing:

```
User: user-123
Action: Read Patient/456
Scopes: user/Patient.read user/Observation.read
Result: Success
```

## Common Patterns

### Mobile Health App

```
openid profile email patient/*.read launch/patient offline_access
```
- User authentication
- Patient-scoped data access
- Offline refresh capability

### Clinician Workstation

```
openid profile user/*.cruds launch/patient launch/encounter fhirUser
```
- User authentication
- Full clinical data access
- Launch from EHR
- User identity

### Analytics Dashboard

```
system/*.read offline_access
```
- System-level read access
- Continuous data access

### Patient Portal

```
openid profile email patient/*.read patient/Communication.cru launch/patient
```
- User authentication
- Read access to patient data
- Limited write access for communications

### Backend Integration

```
system/*.* offline_access
```
- Full system access
- Long-running processes

## Error Handling

### Invalid Scope Errors

When requesting invalid scopes, the authorization server returns an error:

```json
{
  "error": "invalid_scope",
  "error_description": "Invalid smart resource scope: 'user/Patient.xyz'."
}
```

Common invalid scope errors:

- **Out of order permissions**: `user/Patient.dcu` → `Invalid scope access type methods: 'u' not supported or in wrong place must be in 'cruds' order`
- **Invalid user level**: `usr/Patient.read` → `Smart resource scope level 'usr' not supported`
- **Invalid resource type**: `user/InvalidResource.read` → `Smart resource scope resource type 'InvalidResource' not supported`
- **Invalid launch type**: `launch/invalid` → `Launch type 'invalid' not supported`

### Insufficient Scope Errors

When accessing resources without the required scope:

```http
HTTP/1.1 403 Forbidden
Content-Type: application/fhir+json

{
  "resourceType": "OperationOutcome",
  "issue": [
    {
      "severity": "error",
      "code": "forbidden",
      "diagnostics": "Insufficient scope to perform this operation"
    }
  ]
}
```

## Related Resources

- [OpenID Connect Core Specification](https://openid.net/specs/openid-connect-core-1_0.html)
- [SMART App Launch Framework](https://hl7.org/fhir/smart-app-launch/)
- [OAuth 2.0 Scopes](https://datatracker.ietf.org/doc/html/rfc6749#section-3.3)
- [FHIR Resource Types](https://www.hl7.org/fhir/resourcelist.html)

## Summary

Haste Health's scope system provides:

- **OIDC scopes** for authentication and user information
- **SMART scopes** for fine-grained FHIR resource access
- **Three user contexts**: `patient`, `user`, and `system`
- **Five permission types**: create, read, update, delete, search
- **Launch context** for EHR integration
- **Flexible combinations** for various application types

By properly requesting and validating scopes, applications can implement secure, least-privilege access to healthcare data while maintaining compliance with SMART on FHIR standards.
